---
title: "Data"
---

Datasets from the IYS expeditions are in various stages of being published. A dataset status number (1-5) is assgned to datasets and a FAIR (Findable, Accessible, Interoperable, Reusable) badge is assigned when the data reach level 5.

Dataset status levels:

- Level 1: Data only have a metadata record, no data have been received. 
- Level 2: Data have a metadata record, data have been received and are available internally to IYS expedition scientists but not yet published publicly. 
- Level 3: Data have a metadata record and only a subset of the data have been standardized and made publicly available in a domain-specific repository. 
- Level 4: Data have a metadata record and a non-standardized version of the dataset is publicly available.
- Level 5: Data have a metadata record and the full fidelity of the dataset is standardized and available in a domain-specific repository.



```{r setup, include = FALSE}
knitr::opts_chunk$set(include = FALSE, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE)
library(ckanr)
library(tidyverse)
library(reactable)
library(googlesheets4)

```

```{r, include = FALSE}
# ckanr_setup(url = "http://iys.hakai.org")
# pkgs <- package_list_current(as = "table", limit = 2000)
# 
# names(pkgs)
# 
# pkgs <- pkgs %>%
#   mutate(`metadata-point-of-contact` = map(`metadata-point-of-contact`, ~select(.x, c('individual-name', 'contact-info_email'))))
# 
# 
# subset <- pkgs %>%
#   select(title, id = name, `metadata-point-of-contact`, `unique-resource-identifier-full`, extras) %>%
#   filter(`unique-resource-identifier-full` != "NULL")
# 
# constraints <- bind_rows(subset$extras) %>%
#   filter(key == "licence")
# 
# names <- bind_rows(subset$`metadata-point-of-contact`, .id = "Name") %>%
#   distinct(Name, .keep_all = TRUE) %>%
#   select(`Contact Person` = 'individual-name',
#          `Contact email` = 'contact-info_email')
# 
# dois <- bind_rows(subset$`unique-resource-identifier-full`) %>%
#   mutate(dois = paste0("https://doi.org/", code)) %>%
#   select(`Digital Object Identifier`= dois)
# 
# subset <- tibble(`Dataset Title` = subset$title, names, dois, `Access Constraints` = constraints$value) %>%
#   mutate("FAIRness" = if_else(`Access Constraints` == "", 5,4))
# 
# write_csv(subset, here::here("published.csv"))
# #At this stage I read the sheet into google sheets to make manual edits
# not_published <- pkgs %>%
#   select(title, id = name, `metadata-point-of-contact`, `unique-resource-identifier-full`) %>%
#   filter(`unique-resource-identifier-full` == "NULL") %>%
#   mutate(`Metadata Link` = paste0("https://iys.hakai.org/dataset/", id))
# 
# names <- bind_rows(not_published$`metadata-point-of-contact`, .id = "Name") %>%
#   distinct(Name, .keep_all = TRUE) %>%
#   select(`Contact Person` = 'individual-name',
#          `Contact email` = 'contact-info_email')
# 
# not_published <- tibble(`Dataset Title` = not_published$title, names,
#                         `Metadata Link` = not_published$`Metadata Link`) %>%
#   mutate("FAIRness" = 1)
# 
# write_csv(not_published, here::here('not_published.csv'))
```

```{r, include = FALSE}

#(`Dataset Title`,"\\(?[0-9,.]+\\)?")[[1]],
published_data <- read_sheet("https://docs.google.com/spreadsheets/d/1SoeRT_eytuMS3-Ap5q6UPzcwBK2HKiqzsTbWLmxZcBA/edit#gid=1459056304", sheet = "Published")
1
published_data$Year <- str_match_all(published_data$`Dataset Title`, "[0-9]+")

published_data <- published_data %>% 
  mutate(Vessel = if_else(Year == "2019", "Professor Kaganovsky", "Pacific Legacy NO 1"),
         Vessel = if_else(Year == 'c("2019", "2020")', "Professor Kaganovsky, Pacific Legacy NO 1", Vessel),
         Year = as.numeric(ifelse(Year == 'c("2019", "2020")', "20192020", Year))) %>% 
  select(`Dataset Title`, Year, Vessel, `Contact Person`, `Contact email`, `Link to Access Data` = `Digital Object Identifier`, `Access Constraints`:FAIRness)


internal_data <- read_sheet("https://docs.google.com/spreadsheets/d/1SoeRT_eytuMS3-Ap5q6UPzcwBK2HKiqzsTbWLmxZcBA/edit#gid=1459056304", sheet = "Available Internally") 

internal_data$Year <- str_match_all(internal_data$`Dataset Title`, "[0-9]+")

internal_data <- internal_data %>% 
  mutate(Vessel = if_else(Year == "2019", "Professor Kaganovsky", "Pacific Legacy NO 1"),
         Vessel = if_else(Year == 'c("2019", "2020")', "Professor Kaganovsky, Pacific Legacy NO 1", Vessel),
         Year = as.numeric(ifelse(Year == 'c("2019", "2020")', "20192020", Year))) %>% 
  select(`Dataset Title`, Year, Vessel, `Contact Person`, `Contact email`, `Link to Access Data` = `Metadata Link`, Status)

unpublished_data <- read_sheet("https://docs.google.com/spreadsheets/d/1SoeRT_eytuMS3-Ap5q6UPzcwBK2HKiqzsTbWLmxZcBA/edit#gid=1459056304", sheet = "Not Published")

unpublished_data$Year <- str_match_all(unpublished_data$`Dataset Title`, "[0-9]+")
  
unpublished_data <- unpublished_data %>% 
  mutate(Vessel = if_else(Year == "2019", "Professor Kaganovsky", "Pacific Legacy NO 1"),
         Vessel = if_else(Year == 'c("2019", "2020")', "Professor Kaganovsky, Pacific Legacy NO 1", Vessel),
         Year = as.numeric(ifelse(Year == 'c("2019", "2020")', "20192020", Year))) %>% 
  select(`Dataset Title`, Year, Vessel, `Contact Person`:Status, -`Metadata Link`)

```

```{r read in 2022 data}
twenty2 <- read_sheet('https://docs.google.com/spreadsheets/d/1grJN_xPZScd4r-IgUK7v_jnCs5IGKhDDElTskt6qdAQ/edit#gid=1020959877', sheet = 'Master Sheet') %>%
  mutate(Year = 2022) %>% 
  select(`Dataset Title` = 'Dataset Title / Description', Vessel, Year, `Contact Person` = 'Principal Investigator(s)', priority = 'Priority Category (For Brett, Tim and Caroline to fill out)', `Digital Object Identifier`, `Access Constraints` = `Limitations of data`, Status = 'Dataset Publication Status (For Aidan, Brett, Tim to fill out) (1-5 as per IYS About page dataset summary table)')

twenty2$`Contact Person` <- gsub("^(.*?),.*", "\\1", twenty2$`Contact Person`)
twenty2$`Contact Person` <- gsub("^(.*?)/.*", "\\1", twenty2$`Contact Person`)

scientists <- read_sheet('https://docs.google.com/spreadsheets/d/1grJN_xPZScd4r-IgUK7v_jnCs5IGKhDDElTskt6qdAQ/edit#gid=1020959877', sheet = 'Scientists') %>% 
  select('Name', 'Contact email')

twenty2 <- left_join(twenty2, scientists, by = c("Contact Person" = 'Name'))
```

```{r join 2022 with 2019 and 2022 tables}
published_22 <- twenty2 %>% 
  filter(Status > 2) %>% 
  rename(`Link to Access Data` = `Digital Object Identifier`) %>% 
  select(-priority) %>% 
  mutate(FAIRness = if_else(Status == 5, "FAIR", ""))

published_data <- bind_rows(published_data, published_22)

available_internally22 <- twenty2 %>% 
  filter(Status == 2)%>% 
  rename(`Link to Access Data` = `Digital Object Identifier`) %>% 
  select(-priority)  

internal_data <- bind_rows(internal_data, available_internally22) %>% 
  mutate(`Access Constraints` = "Internal access only")

unavailable22 <- twenty2 %>% 
  filter(Status %in% c(NA, 0, 1)) %>% 
  select(-priority)

unpublished_data <- bind_rows(unpublished_data, unavailable22) %>% 
  select(-`Digital Object Identifier`, `Access Constraints`)
```

# Available Data {.tabset .tabset-pills}

## Published Data

Table 1. Data that have been published and are publicly available. 
```{r, include = TRUE}

reactable(published_data, 
          columns = list(
          `Link to Access Data` = colDef(html = TRUE, cell = JS("
    function(cellInfo) {
      // Render as a link
      const url = cellInfo.value
      return '<a href=\"' + url + '\" target=\"_blank\">' + cellInfo.value + '</a>'
    }
  "))),
          searchable = TRUE, resizable = TRUE, defaultSorted = list(Status = 'desc'))
```

## Data Available Internally



#### **IMPORTANT: To access internal data you must:**

* Register for a GitHub account https://github.com/signup
* Email iys.data@hakai.org your GitHub username (so we can add you as an approved user)
* Log in to GitHub before clicking on links below
* Offer data providers with collaboration opportunity according the the [IYS Data Policy](https://international-year-of-the-salmon.github.io/about/Final%20IYS%20Data%20Policy_Dec132021.pdf)

Table 2. Data that are not yet available publicly but are available internally.

```{r, include = TRUE}
reactable(internal_data,
          columns = list(
          `Link to Access Data` = colDef(html = TRUE, cell = JS("
    function(cellInfo) {
      // Render as a link
      const url = cellInfo.value
      return '<a href=\"' + url + '\" target=\"_blank\">' + cellInfo.value + '</a>'
    }
  "))),
  searchable = TRUE, resizable = TRUE, 
          defaultSorted = list(Status = 'desc'))
```


## Data Not Received

Table 3. Data that have not yet been received and/or published. Please contact the data provider for data access.
```{r, include = TRUE}
reactable(unpublished_data, searchable = TRUE, resizable = TRUE,
          defaultSorted = list(Status = 'desc'))
```

## Priority 2022 Data Not Received

```{r Priority data table, include = TRUE}
priority22 <- twenty2 |> 
  filter(priority == 1) |> 
  select(`Dataset Title`, Vessel, Year, `Contact Person`, Status)

reactable(priority22, searchable = TRUE, resizable = TRUE, defaultSorted = c( 'Vessel', 'Dataset Title', 'Status'))

p22 <- priority22 |> 
  filter(!Vessel %in% c('Argo Floats', 'Glider')) |> 
  group_by(Vessel) |> 
  mutate(n = n()) |> 
  ungroup() |> 
  mutate(received = if_else(Status >= 1, "received", "not_received")) |> 
  filter(received == "received") |> 
  group_by(Vessel, received) |> 
  mutate(n_received = n()) |> 
  group_by(Vessel) |> 
  summarize(prop = n_received / n) |> 
  distinct() |> 
  mutate(`Not Received` = 1 - prop) |> 
  select(Vessel, "Received" = prop, `Not Received`) |> 
  pivot_longer(cols = Received:`Not Received`, names_to = "type", values_to = "props") |> 
  ungroup()
  
p22 <- add_row(p22,"Vessel" = "Raw Spirit", type = "Received", props = 0.0)  
p22 <- add_row(p22,"Vessel" = "Raw Spirit", type= "Not Received", props = 1)

ggplot(p22, aes(x= "", y = props, fill = type)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar("y", start = 0) +
  facet_wrap(~Vessel) +
  theme_void() +
  labs(caption = "Figure 1. Proportion of each vessels priority data received or not") +
  theme(legend.title=element_blank())

p_total_22 <- priority22 |> 
  filter(!Vessel %in% c('Argo Floats', 'Glider')) |> 
  mutate(received = if_else(Status >= 1, "received", "not_received")) |> 
  filter(received == "received") |> 
  mutate(n_datasets = length(Vessel)) |> 
  group_by(Vessel) |> 
  mutate(n_received = n()) |> 
  group_by(Vessel) |> 
  summarize(prop = n_received / n_datasets) |> 
  distinct()

ggplot(p_total_22, aes(x = "", y = prop, fill = Vessel)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar("y", start = 0) +
  theme_void() +
  labs(caption = "Figure 2. Proportion of total priority data received by vessel")
  

```

