name: Update R Visualization and Deploy MKDocs

on:
  push:
    branches:
      - develop  # Trigger the action on push events to the main branch
  schedule:
    - cron: '0 0 * * *'  # Runs every day at midnight UTC

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      R_LIBS_USER: '~/R/library'
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4 

    - name: Set up pandoc  
      uses: r-lib/actions/setup-pandoc@v2
      with:
        pandoc-version: '2.17.1'
    - run: echo "# Test" | pandoc -t html

    - name: Setup R
      uses: r-lib/actions/setup-r@v2
    
    - name: Install dependencies
      uses: r-lib/actions/setup-r-dependencies@v2
      with:
        packages: "dplyr, readr, rdatacite, networkD3" 
    
    - name: Run R Script to Generate HTML
      run: Rscript dataset-summary.R 
      
    - name: Inject HTML into Markdown
        run: |
          # Extract HTML content from generated HTML file
          html_content=$(sed -n '/<body>/,/<\/body>/p' network.html)
          
          # Replace the placeholder div in Markdown file with the HTML content
          sed -i "s|<div id=\"networkD3-container\"></div>|<div id=\"networkD3-container\">$html_content</div>|g" path/to/your/file.md
 
    - name: Build docs
      run: |
        git config --global user.name "${GITHUB_ACTOR}"
        git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"
        cd docs
        git pull
        poetry run mkdocs gh-deploy --clean